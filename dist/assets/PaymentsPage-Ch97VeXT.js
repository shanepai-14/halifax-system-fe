import{j as e,a5 as De,aK as Re,a0 as we,aV as Te,r as d,U as r,V as f,W as b,T as a,K as y,a4 as H,N as F,Z as U,E as V,P as ke,aW as Fe,aX as Ve,aY as Ie,aZ as Y,X as I}from"./index-D1vLSOsd.js";import{u as M,w as Me}from"./xlsx-DjuO7_Ju.js";import{u as We,R as Ae,P as ze}from"./PaymentReceipt-oqmPJ8Fh.js";import{a as _,b as s,T as C,S as J,c as Ee,d as Oe,e as $e,f as Be}from"./TextField-CAUdsbBs.js";import{S as c}from"./Skeleton-CQLtffOm.js";import{a as Q,f as W}from"./dateUtils-Dj0n6tHU.js";import{f as P}from"./currencyFormat-th2sljt-.js";import{C as qe}from"./Container-BLpVLfE0.js";import{R as Ke}from"./SearchOutlined-HR_qsboI.js";import{R as Le}from"./FilterOutlined-BiJnbV7S.js";import{I as ee}from"./InputLabel-BM0efXBe.js";import{M as x}from"./MenuItem-C2kr_9OP.js";import{R as Ne}from"./DeleteOutlined-BnuyEXxN.js";import{T as Xe}from"./TablePagination-CgqTpu_2.js";import{D as te}from"./Dialog-BzM5BdDx.js";import"./index-D2BPaCGq.js";import"./Close-B4OrAe8F.js";import"./PrinterOutlined-D80eR5BB.js";import"./CloseOutlined-MpBC__Z8.js";import"./KeyboardArrowRight-DQCZ4-5i.js";import"./LastPage-wvwuAEYR.js";const Ze=()=>e.jsxs(_,{children:[e.jsx(s,{children:e.jsx(c,{variant:"text",width:"90%",height:20})}),e.jsx(s,{children:e.jsx(c,{variant:"text",width:"90%",height:20})}),e.jsx(s,{children:e.jsx(c,{variant:"text",width:"90%",height:20})}),e.jsx(s,{children:e.jsx(c,{variant:"text",width:"90%",height:20})}),e.jsx(s,{children:e.jsx(c,{variant:"text",width:"90%",height:20})}),e.jsx(s,{align:"right",children:e.jsx(c,{variant:"text",width:"90%",height:20})}),e.jsx(s,{children:e.jsx(c,{variant:"rounded",width:70,height:22})}),e.jsx(s,{children:e.jsx(c,{variant:"text",width:"90%",height:20})}),e.jsx(s,{align:"right",children:e.jsx(c,{variant:"rounded",width:90,height:30})})]}),se=g=>({cash:"Cash",credit_card:"Credit Card",debit_card:"Debit Card",cheque:"Cheque",bank_transfer:"Bank Transfer",online:"Online Payment",mobile_payment:"Mobile Payment",store_credit:"Store Credit"})[g]||g,jt=()=>{var K,L,N,X;const g=De(),m=Re(),n=we(Te),{payments:l,isLoading:S,getAllPayments:ae,getPaymentStats:re,voidPayment:ne}=We(),[D,R]=d.useState(0),[v,ie]=d.useState(10),[oe,A]=d.useState(null),[le,z]=d.useState(!1),[de,E]=d.useState(!1),[u,O]=d.useState(""),[j,$]=d.useState(null),[p,ce]=d.useState({total_payments:0,total_amount:0,total_voided:0,voided_amount:0});d.useEffect(()=>{w()},[n.paymentMethodFilter,n.statusFilter,n.startDate,n.endDate]);const w=async()=>{const t={payment_method:n.paymentMethodFilter!=="all"?n.paymentMethodFilter:void 0,status:n.statusFilter!=="all"?n.statusFilter:void 0,date_from:n.startDate||void 0,date_to:n.endDate||void 0,search:n.searchTerm||void 0};await ae(t);const o={date_from:t.date_from,date_to:t.date_to},h=await re(o);h&&ce(h)},he=(t,o)=>{R(o)},xe=t=>{ie(parseInt(t.target.value,10)),R(0)},me=t=>{m(Fe(t.target.value))},B=()=>{R(0),w()},ue=t=>{t.key==="Enter"&&B()},je=t=>{m(Ve(t.target.value))},ve=t=>{m(Ie(t.target.value))},ge=t=>{m(Y({startDate:t.target.value,endDate:n.endDate}))},pe=t=>{m(Y({startDate:n.startDate,endDate:t.target.value}))},fe=t=>{g(`/app/delivery-report/${t}`)},be=t=>{const o={payment:t,sale:t.sale};A(o),z(!0)},q=()=>{z(!1),A(null)},ye=t=>{$(t),E(!0)},T=()=>{E(!1),O(""),$(null)},Ce=async()=>{if(u.trim())try{await ne(j.id,u),T(),w()}catch(t){console.error("Error voiding payment:",t)}},Pe=t=>t==="completed"?e.jsx(I,{label:"Completed",color:"success",size:"small"}):t==="voided"?e.jsx(I,{label:"Voided",color:"error",size:"small"}):e.jsx(I,{label:t,size:"small"}),_e=()=>{if(!l||!l.data||l.data.length===0)return;const t=l.data.map(i=>{var Z,G;return{"Date & Time":Q(i.created_at),"Reference #":`${i.reference_number} (${W(i.payment_date)??""})`,"Invoice #":((Z=i.sale)==null?void 0:Z.invoice_number)||"",Customer:(G=i.sale)!=null&&G.customer?typeof i.sale.customer=="object"?i.sale.customer.customer_name:i.sale.customer:"Walk-in Customer",Method:se(i.payment_method),Amount:i.amount,Status:i.status,"Received By":typeof i.received_by=="object"?i.received_by.customer_name:i.received_by||"System"}}),o=M.json_to_sheet(t),h=M.book_new();M.book_append_sheet(h,o,"Payments");const Se=`Payments_Export_${new Date().toISOString().split("T")[0]}.xlsx`;Me(h,Se)};return e.jsxs(qe,{maxWidth:"xxl",sx:{mt:0,p:"0!important"},children:[e.jsxs(r,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(r,{item:!0,xs:12,md:3,children:e.jsx(f,{children:e.jsxs(b,{children:[e.jsx(a,{variant:"subtitle2",sx:{mb:1,color:"text.secondary"},children:"Total Payments"}),e.jsx(a,{variant:"h4",children:p.total_payments||0}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"For the selected date range"})]})})}),e.jsx(r,{item:!0,xs:12,md:3,children:e.jsx(f,{children:e.jsxs(b,{children:[e.jsx(a,{variant:"subtitle2",sx:{mb:1,color:"text.secondary"},children:"Total Amount"}),e.jsx(a,{variant:"h4",children:P(p.total_amount||0)}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"For the selected date range"})]})})}),e.jsx(r,{item:!0,xs:12,md:3,children:e.jsx(f,{children:e.jsxs(b,{children:[e.jsx(a,{variant:"subtitle2",sx:{mb:1,color:"text.secondary"},children:"Voided Payments"}),e.jsx(a,{variant:"h4",children:p.total_voided||0}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"For the selected date range"})]})})}),e.jsx(r,{item:!0,xs:12,md:3,children:e.jsx(f,{children:e.jsxs(b,{children:[e.jsx(a,{variant:"subtitle2",sx:{mb:1,color:"text.secondary"},children:"Voided Amount"}),e.jsx(a,{variant:"h4",children:P(p.voided_amount||0)}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"For the selected date range"})]})})})]}),e.jsx(y,{sx:{mb:3},children:e.jsxs(r,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(r,{item:!0,xs:12,md:3,children:e.jsx(C,{fullWidth:!0,placeholder:"Search by reference or invoice",variant:"outlined",size:"small",value:n.searchTerm,onChange:me,onKeyPress:ue,InputProps:{startAdornment:e.jsx(H,{position:"start",children:e.jsx(Ke,{})}),endAdornment:e.jsx(H,{position:"end",children:e.jsx(F,{onClick:B,size:"small",children:e.jsx(Le,{})})})}})}),e.jsx(r,{item:!0,xs:6,md:2,children:e.jsxs(U,{fullWidth:!0,size:"small",children:[e.jsx(ee,{children:"Payment Method"}),e.jsxs(J,{value:n.paymentMethodFilter,onChange:je,label:"Payment Method",children:[e.jsx(x,{value:"all",children:"All Methods"}),e.jsx(x,{value:"cod",children:"COD"}),e.jsx(x,{value:"cash",children:"Cash"}),e.jsx(x,{value:"cheque",children:"Cheque"}),e.jsx(x,{value:"online",children:"Online Payment"})]})]})}),e.jsx(r,{item:!0,xs:6,md:2,children:e.jsxs(U,{fullWidth:!0,size:"small",children:[e.jsx(ee,{children:"Status"}),e.jsxs(J,{value:n.statusFilter,onChange:ve,label:"Status",children:[e.jsx(x,{value:"all",children:"All Status"}),e.jsx(x,{value:"completed",children:"Completed"}),e.jsx(x,{value:"voided",children:"Voided"})]})]})}),e.jsx(r,{item:!0,xs:6,md:2,children:e.jsx(C,{label:"Start Date",type:"date",value:n.startDate,onChange:ge,InputLabelProps:{shrink:!0},size:"small",fullWidth:!0})}),e.jsx(r,{item:!0,xs:6,md:2,children:e.jsx(C,{label:"End Date",type:"date",value:n.endDate,onChange:pe,InputLabelProps:{shrink:!0},size:"small",fullWidth:!0,inputProps:{min:n.startDate}})}),e.jsx(r,{item:!0,xs:6,md:1,children:e.jsx(V,{variant:"contained",size:"small",fullWidth:!0,onClick:_e,children:"Export"})})]})}),e.jsx(Ee,{component:ke,children:e.jsxs(Oe,{size:"small",children:[e.jsx($e,{children:e.jsxs(_,{children:[e.jsx(s,{children:"Date & Time"}),e.jsx(s,{children:"Reference #"}),e.jsx(s,{children:"Invoice #"}),e.jsx(s,{children:"Customer"}),e.jsx(s,{children:"Method"}),e.jsx(s,{align:"right",children:"Amount"}),e.jsx(s,{children:"Status"}),e.jsx(s,{children:"Received By"}),e.jsx(s,{align:"right",children:"Actions"})]})}),e.jsx(Be,{children:S?Array(v).fill(0).map((t,o)=>e.jsx(Ze,{},o)):l&&((K=l.data)==null?void 0:K.length)>0?(L=l.data)==null?void 0:L.slice(D*v,D*v+v).map(t=>{var o,h;return e.jsxs(_,{sx:{backgroundColor:t.status==="voided"?"#fff8f8":"inherit"},children:[e.jsx(s,{children:Q(t.created_at)}),e.jsx(s,{children:t.payment_method==="cheque"?`${t.reference_number||"-"} (${W(t.payment_date)})`:t.reference_number||"-"}),e.jsx(s,{children:e.jsx(a,{variant:"body2",sx:{cursor:"pointer",color:"primary.main","&:hover":{textDecoration:"underline"}},onClick:()=>{var k;return fe((k=t.sale)==null?void 0:k.id)},children:(o=t.sale)==null?void 0:o.invoice_number})}),e.jsx(s,{children:(h=t.sale)!=null&&h.customer?typeof t.sale.customer=="object"?t.sale.customer.customer_name:t.sale.customer:"Walk-in Customer"}),e.jsx(s,{children:se(t.payment_method)}),e.jsx(s,{align:"right",children:P(t.amount)}),e.jsx(s,{children:Pe(t.status)}),e.jsx(s,{children:typeof t.received_by=="object"?t.received_by.customer_name:t.received_by||"System"}),e.jsxs(s,{align:"right",children:[e.jsx(F,{size:"small",color:"primary",onClick:()=>be(t),title:"View Receipt",children:e.jsx(Ae,{})}),(t.status==="pending"||t.status==="completed")&&e.jsx(F,{size:"small",color:"error",onClick:()=>ye(t),title:"Void Payment",children:e.jsx(Ne,{})})]})]},t.id)}):e.jsx(_,{children:e.jsx(s,{colSpan:9,align:"center",children:e.jsx(a,{variant:"body1",sx:{py:2},children:"No payments found"})})})})]})}),e.jsx(Xe,{rowsPerPageOptions:[5,10,25,50],component:"div",count:l?(N=l.data)==null?void 0:N.length:0,rowsPerPage:v,page:D,onPageChange:he,onRowsPerPageChange:xe}),e.jsx(te,{open:le,onClose:q,maxWidth:"md",fullWidth:!0,children:e.jsx(ze,{paymentRecord:oe,onClose:q})}),e.jsx(te,{open:de,onClose:T,maxWidth:"sm",fullWidth:!0,children:e.jsxs(y,{sx:{p:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Void Payment"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"Are you sure you want to void this payment? This action cannot be undone."}),j&&e.jsx(y,{sx:{mb:3,p:2,bgcolor:"background.level1",borderRadius:1},children:e.jsxs(r,{container:!0,spacing:1,children:[e.jsx(r,{item:!0,xs:6,children:e.jsx(a,{variant:"body2",children:e.jsx("strong",{children:"Reference:"})})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(a,{variant:"body2",children:j.reference_number})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(a,{variant:"body2",children:e.jsx("strong",{children:"Invoice:"})})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(a,{variant:"body2",children:(X=j.sale)==null?void 0:X.invoice_number})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(a,{variant:"body2",children:e.jsx("strong",{children:"Amount:"})})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(a,{variant:"body2",children:P(j.amount)})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(a,{variant:"body2",children:e.jsx("strong",{children:"Date:"})})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(a,{variant:"body2",children:W(j.payment_date)})})]})}),e.jsx(C,{label:"Reason for voiding payment",fullWidth:!0,multiline:!0,rows:3,value:u,onChange:t=>O(t.target.value),required:!0,error:!u.trim(),helperText:u.trim()?"":"Reason is required",margin:"normal",sx:{mb:2}}),e.jsxs(y,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:[e.jsx(V,{onClick:T,sx:{mr:1},children:"Cancel"}),e.jsx(V,{variant:"contained",color:"error",onClick:Ce,disabled:!u.trim()||S,children:S?"Processing...":"Void Payment"})]})]})})]})};export{jt as default};
