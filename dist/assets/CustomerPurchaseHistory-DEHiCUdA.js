import{V as fe,K as be,r as l,W as ye,j as e,M as L,v as o,X as K,T as s,l as N,Y as ve,ae as _e,P as I,G as g,F as Ce,J as $,z as X,D as Ie}from"./index-DeRU5HNF.js";import{f as _,a as E}from"./currencyFormat-BsuV9MhS.js";import{u as F,w as ke}from"./xlsx-DjuO7_Ju.js";import{R as Y,a as Te,b as O}from"./LeftOutlined-CcelUQ2f.js";import{L as D}from"./Link-Czyf3azh.js";import{R as Re}from"./HomeOutlined-CO4yDJya.js";import{R as Se,a as z}from"./TeamOutlined-C9KvFSvs.js";import{T as we,c as Z,d as ee,e as te,a as k,b as r,f as re}from"./TextField-BYf4anuv.js";import{R as De}from"./SearchOutlined-BPbN8RAA.js";import{T as Pe,a as se}from"./Tabs-CROoasCq.js";import"./InputLabel-p4Y1ucBq.js";import"./KeyboardArrowRight-DrhUjlpq.js";function ne(x){const{children:j,value:f,index:b,...C}=x;return e.jsx("div",{role:"tabpanel",hidden:f!==b,id:`simple-tabpanel-${b}`,"aria-labelledby":`simple-tab-${b}`,...C,children:f===b&&e.jsx(o,{sx:{pt:2},children:j})})}const Ve=()=>{const{customerId:x}=fe(),j=be(),[f,b]=l.useState(0),[C,H]=l.useState(!0),[ie,M]=l.useState(!0),[q,oe]=l.useState(null),[m,V]=l.useState(null),[h,T]=l.useState([]),[Q,G]=l.useState(1),[U,le]=l.useState(!0),[P,ce]=l.useState(""),[c,de]=l.useState({key:null,direction:"asc"}),R=l.useRef(),ue=l.useRef(),xe=(t,n)=>{b(n)},W=()=>{j("/app/customer")},S=l.useCallback(async(t=1,n=!1)=>{var a;if(x)try{H(!0);const d=await ye.get(`/sales/customers/${x}/purchase-history?page=${t}&per_page=50`);n?(V(d.data.data),T(d.data.data.items||[])):(V(y=>{if(!y)return d.data.data;const v=[...y.items,...d.data.data.items||[]],u=Array.from(new Map(v.map(J=>[J.item_id,J])).values());return{...d.data.data,items:u}}),T(y=>{const v=[...y,...d.data.data.items||[]];return Array.from(new Map(v.map(u=>[u.item_id,u])).values())})),le(((a=d.data.data.pagination)==null?void 0:a.has_more)||!1),M(!1)}catch(d){oe(d.message||"Failed to load data"),M(!1)}finally{H(!1)}},[x]),he=l.useCallback(t=>{C||(R.current&&R.current.disconnect(),R.current=new IntersectionObserver(n=>{if(n[0].isIntersecting&&U){const a=Q+1;G(a),S(a)}}),t&&R.current.observe(t))},[C,U,Q,S]);l.useEffect(()=>{G(1),S(1,!0)},[x,S]),l.useEffect(()=>{if(!m)return;const t=m.items.filter(n=>{const a=P.toLowerCase();return n.invoice_number.toLowerCase().includes(a)||n.product_name.toLowerCase().includes(a)||n.total.toString().includes(a)||n.product_code&&n.product_code.toLowerCase().includes(a)});T(t)},[P,m]);const A=t=>{let n="asc";c.key===t&&c.direction==="asc"&&(n="desc"),de({key:t,direction:n})};l.useEffect(()=>{if(!c.key||!h.length)return;const t=[...h].sort((n,a)=>n[c.key]<a[c.key]?c.direction==="asc"?-1:1:n[c.key]>a[c.key]?c.direction==="asc"?1:-1:0);T(t)},[c]);const je=()=>{var v;if(!h.length)return;const t=h.map(u=>({"DR Number":u.invoice_number,Product:u.product_name,"Product Code":u.product_code||"N/A",Quantity:u.quantity,Price:u.price,Discount:u.discount+"%",Total:u.total,Date:u.order_date,Status:u.status})),n=F.json_to_sheet(t),a=F.book_new();F.book_append_sheet(a,n,"Purchase History");const d=((v=m==null?void 0:m.customer)==null?void 0:v.customer_name)||"Customer",y=new Date().toISOString().split("T")[0];ke(a,`${d}_Purchase_History_${y}.xlsx`)};if(ie)return e.jsx(L,{children:e.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"400px"},children:e.jsx(K,{})})});if(q)return e.jsxs(L,{children:[e.jsxs(s,{variant:"h5",color:"error",align:"center",children:["Error: ",q]}),e.jsx(o,{sx:{mt:2,textAlign:"center"},children:e.jsx(N,{variant:"contained",onClick:W,startIcon:e.jsx(Y,{}),children:"Back to Customers"})})]});const{customer:i,items:p}=m||{},w={};p&&p.length>0&&p.forEach(t=>{w[t.invoice_number]||(w[t.invoice_number]={invoice_number:t.invoice_number,order_date:t.order_date,delivery_date:t.delivery_date,status:t.status,items:[]}),w[t.invoice_number].items.push(t)});const B=Object.values(w).sort((t,n)=>new Date(n.order_date)-new Date(t.order_date)),me=p?p.reduce((t,n)=>t+parseFloat(n.total),0):0,pe=p?p.reduce((t,n)=>t+parseInt(n.quantity),0):0,ge=B.length;return e.jsxs(L,{children:[e.jsxs(ve,{sx:{mb:2},children:[e.jsxs(D,{underline:"hover",color:"inherit",sx:{display:"flex",alignItems:"center",cursor:"pointer"},onClick:()=>j("/app/dashboard"),children:[e.jsx(Re,{style:{marginRight:8}}),"Dashboard"]}),e.jsxs(D,{underline:"hover",color:"inherit",sx:{display:"flex",alignItems:"center",cursor:"pointer"},onClick:()=>j("/app/customer"),children:[e.jsx(Se,{style:{marginRight:8}}),"Customers"]}),e.jsxs(s,{color:"text.primary",sx:{display:"flex",alignItems:"center"},children:[e.jsx(_e,{style:{marginRight:8}}),"Purchase History"]})]}),e.jsx(N,{variant:"outlined",startIcon:e.jsx(Y,{}),onClick:W,sx:{mb:3},children:"Back to Customers"}),e.jsxs(I,{sx:{p:3,mb:4},children:[e.jsx(s,{variant:"h5",gutterBottom:!0,children:"Customer Details"}),e.jsxs(g,{container:!0,spacing:2,children:[e.jsxs(g,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"subtitle1",children:"Name:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.customer_name)||"N/A"}),(i==null?void 0:i.business_name)&&e.jsxs(e.Fragment,{children:[e.jsx(s,{variant:"subtitle1",children:"Business:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:i.business_name})]}),e.jsx(s,{variant:"subtitle1",children:"Contact Number:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.contact_number)||"N/A"})]}),e.jsxs(g,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"subtitle1",children:"Email:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.email)||"N/A"}),e.jsx(s,{variant:"subtitle1",children:"Address:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.address)||"N/A"}),e.jsx(s,{variant:"subtitle1",children:"City:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.city)||"N/A"})]})]})]}),e.jsxs(I,{sx:{p:3,mb:4},children:[e.jsx(s,{variant:"h5",gutterBottom:!0,children:"Purchase Summary"}),e.jsxs(g,{container:!0,spacing:3,children:[e.jsx(g,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Orders"}),e.jsx(s,{variant:"h4",sx:{my:1},children:ge})]})}),e.jsx(g,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Items Purchased"}),e.jsx(s,{variant:"h4",sx:{my:1},children:pe})]})}),e.jsx(g,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Purchase Amount"}),e.jsx(s,{variant:"h4",sx:{my:1},children:_(me)})]})})]})]}),e.jsx(o,{sx:{mb:3},children:e.jsx(we,{fullWidth:!0,placeholder:"Search by DR #, Product Name or Total...",variant:"outlined",value:P,onChange:t=>ce(t.target.value),InputProps:{startAdornment:e.jsx(Ce,{position:"start",children:e.jsx(De,{})})}})}),e.jsxs(I,{sx:{p:3},children:[e.jsx(o,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Pe,{value:f,onChange:xe,"aria-label":"purchase history tabs",children:[e.jsx(se,{label:"All Items",id:"tab-0"}),e.jsx(se,{label:"By Orders",id:"tab-1"})]})}),e.jsxs(ne,{value:f,index:0,children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignContent:"center",mb:1},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"All Purchased Items"}),e.jsx(N,{variant:"contained",color:"success",size:"small",startIcon:e.jsx(Te,{}),onClick:je,disabled:!h.length,children:"Export to Excel"})]}),h.length>0?e.jsx(Z,{component:I,variant:"outlined",children:e.jsxs(ee,{size:"small",children:[e.jsx(te,{children:e.jsxs(k,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{onClick:()=>A("invoice_number"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx($,{title:"Sort by DR Number",arrow:!0,children:e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:["DR Number",c.key==="invoice_number"&&(c.direction==="asc"?e.jsx(z,{style:{marginLeft:8}}):e.jsx(O,{style:{marginLeft:8}}))]})})}),e.jsx(r,{onClick:()=>A("product_name"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx($,{title:"Sort by Product Name",arrow:!0,children:e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:["Product",c.key==="product_name"&&(c.direction==="asc"?e.jsx(z,{style:{marginLeft:8}}):e.jsx(O,{style:{marginLeft:8}}))]})})}),e.jsx(r,{children:"Code"}),e.jsx(r,{onClick:()=>A("order_date"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx($,{title:"Sort by Date",arrow:!0,children:e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:["Date",c.key==="order_date"&&(c.direction==="asc"?e.jsx(z,{style:{marginLeft:8}}):e.jsx(O,{style:{marginLeft:8}}))]})})}),e.jsx(r,{align:"right",children:"Unit Price"}),e.jsx(r,{align:"center",children:"Quantity"}),e.jsx(r,{align:"right",children:"Discount"}),e.jsx(r,{align:"right",children:"Total"}),e.jsx(r,{children:"Status"})]})}),e.jsx(re,{children:h.map((t,n)=>{const a=n===h.length-1;return e.jsxs(k,{ref:a?he:null,children:[e.jsx(r,{children:e.jsx(D,{href:"#",onClick:()=>j(`/app/sales/${t.sale_id}`),sx:{textDecoration:"none"},children:t.invoice_number})}),e.jsx(r,{children:t.product_name}),e.jsx(r,{children:t.product_code||"N/A"}),e.jsx(r,{children:E(t.order_date)}),e.jsx(r,{align:"right",children:_(t.price)}),e.jsx(r,{align:"center",children:t.quantity}),e.jsxs(r,{align:"right",children:[parseFloat(t.discount).toFixed(2),"%"]}),e.jsx(r,{align:"right",children:_(t.total)}),e.jsx(r,{children:e.jsx(X,{label:t.status,color:ae(t.status),size:"small"})})]},t.item_id)})})]})}):e.jsx(o,{sx:{p:4,textAlign:"center"},children:e.jsx(s,{variant:"body1",color:"text.secondary",children:"No purchase history found for this customer."})}),C&&e.jsx(o,{ref:ue,sx:{display:"flex",justifyContent:"center",p:2},children:e.jsx(K,{size:30})})]}),e.jsxs(ne,{value:f,index:1,children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Purchases By Order"}),B.length>0?e.jsx(e.Fragment,{children:B.map(t=>{const n=t.items.reduce((a,d)=>a+parseFloat(d.total),0);return e.jsxs(o,{sx:{mb:4},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(o,{children:[e.jsx(s,{variant:"h6",sx:{color:"primary.main"},children:e.jsxs(D,{href:"#",onClick:()=>j(`/app/sales/${t.items[0].sale_id}`),sx:{textDecoration:"none"},children:["DR #: ",t.invoice_number]})}),e.jsxs(s,{variant:"body2",children:["Order Date: ",E(t.order_date)," | Delivery Date: ",E(t.delivery_date)]})]}),e.jsx(o,{children:e.jsx(X,{label:t.status,color:ae(t.status),size:"small"})})]}),e.jsx(Z,{component:I,variant:"outlined",children:e.jsxs(ee,{size:"small",children:[e.jsx(te,{children:e.jsxs(k,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{children:"Product"}),e.jsx(r,{children:"Code"}),e.jsx(r,{align:"right",children:"Unit Price"}),e.jsx(r,{align:"center",children:"Quantity"}),e.jsx(r,{align:"right",children:"Discount"}),e.jsx(r,{align:"right",children:"Total"})]})}),e.jsxs(re,{children:[t.items.map((a,d)=>e.jsxs(k,{children:[e.jsx(r,{children:a.product_name}),e.jsx(r,{children:a.product_code||"N/A"}),e.jsx(r,{align:"right",children:_(a.price)}),e.jsx(r,{align:"center",children:a.quantity}),e.jsxs(r,{align:"right",children:[parseFloat(a.discount).toFixed(2),"%"]}),e.jsx(r,{align:"right",children:_(a.total)})]},d)),e.jsxs(k,{children:[e.jsx(r,{colSpan:4}),e.jsx(r,{align:"right",children:e.jsx(s,{variant:"subtitle2",children:"Order Total:"})}),e.jsx(r,{align:"right",children:e.jsx(s,{variant:"subtitle2",children:_(n)})})]})]})]})}),e.jsx(Ie,{sx:{my:4}})]},t.invoice_number)})}):e.jsx(o,{sx:{p:4,textAlign:"center"},children:e.jsx(s,{variant:"body1",color:"text.secondary",children:"No purchase orders found for this customer."})})]})]})]})},ae=x=>{switch(x.toLowerCase()){case"completed":return"success";case"pending":return"warning";case"cancelled":return"error";case"partially_paid":case"partially_returned":return"info";case"unpaid":return"default";default:return"default"}};export{Ve as default};
