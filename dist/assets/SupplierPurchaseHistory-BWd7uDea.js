import{ab as je,a5 as pe,r as l,Y as me,j as e,M as K,K as i,_ as W,T as s,E as N,ac as ge,aa as ye,P as k,U as m,a4 as be,$ as P,X,L as fe}from"./index-xwmzBjKc.js";import{f as Y}from"./dateUtils-Dj0n6tHU.js";import{f as b}from"./currencyFormat-th2sljt-.js";import{u as E,w as _e}from"./xlsx-DjuO7_Ju.js";import{R as J,a as T}from"./LeftOutlined-CpDBo9Ns.js";import{L as D,R as ve}from"./HomeOutlined-szl0Qmp0.js";import{R as Ce,a as w}from"./TeamOutlined-CCMY2fER.js";import{T as Ie,c as Z,d as ee,e as te,a as R,b as r,f as re}from"./TextField-DCIWO7cf.js";import{R as Se}from"./SearchOutlined-B0MC_ZEg.js";import{T as ke,a as se}from"./Tabs-Bca1Li4C.js";import{R as Pe}from"./FileExcelOutlined-CKGcZrJr.js";import"./InputLabel-C2i1ZWo5.js";import"./KeyboardArrowRight-CYdB9ioT.js";function ne(f){const{children:g,value:_,index:v,...C}=f;return e.jsx("div",{role:"tabpanel",hidden:_!==v,id:`simple-tabpanel-${v}`,"aria-labelledby":`simple-tab-${v}`,...C,children:_===v&&e.jsx(i,{sx:{pt:2},children:g})})}const Me=()=>{const{supplierId:f}=je(),g=pe(),[_,v]=l.useState(0),[C,O]=l.useState(!0),[ae,z]=l.useState(!0),[H,ie]=l.useState(null),[y,M]=l.useState(null),[p,L]=l.useState([]),[q,F]=l.useState(1),[Q,oe]=l.useState(!0),[$,ce]=l.useState(""),[o,le]=l.useState({key:null,direction:"asc"}),B=l.useRef(),de=l.useRef(),xe=(t,n)=>{v(n)},U=()=>{g("/app/supplier")},A=l.useCallback(async(t=1,n=!1)=>{var a;if(f)try{O(!0);const d=await me.get(`/suppliers/${f}/purchase-history?page=${t}&per_page=50`);n?(M(d.data.data),L(d.data.data.items||[])):(M(c=>{if(!c)return d.data.data;const h=[...c.items,...d.data.data.items||[]],u=Array.from(new Map(h.map(G=>[G.received_item_id,G])).values());return{...d.data.data,items:u,items_by_po:d.data.data.items_by_po}}),L(c=>{const h=[...c,...d.data.data.items||[]];return Array.from(new Map(h.map(u=>[u.received_item_id,u])).values())})),oe(((a=d.data.data.pagination)==null?void 0:a.has_more)||!1),z(!1)}catch(d){ie(d.message||"Failed to load data"),z(!1)}finally{O(!1)}},[f]),ue=l.useCallback(t=>{C||(B.current&&B.current.disconnect(),B.current=new IntersectionObserver(n=>{if(n[0].isIntersecting&&Q){const a=q+1;F(a),A(a)}}),t&&B.current.observe(t))},[C,Q,q,A]);l.useEffect(()=>{F(1),A(1,!0)},[f,A]),l.useEffect(()=>{if(!y)return;const t=y.items.filter(n=>{const a=$.toLowerCase();return n.po_number.toLowerCase().includes(a)||n.product_name.toLowerCase().includes(a)||n.total_cost.toString().includes(a)||n.batch_number.toLowerCase().includes(a)||n.grand_total.toLowerCase().includes(a)||n.product_category&&n.product_category.toLowerCase().includes(a)});L(t)},[$,y]);const I=t=>{let n="asc";o.key===t&&o.direction==="asc"&&(n="desc"),le({key:t,direction:n})};l.useEffect(()=>{if(!o.key||!p.length)return;const t=[...p].sort((n,a)=>n[o.key]<a[o.key]?o.direction==="asc"?-1:1:n[o.key]>a[o.key]?o.direction==="asc"?1:-1:0);L(t)},[o]);const he=()=>{var h;if(!p.length)return;const t=p.map(u=>({"PO Number":u.po_number,Product:u.product_name,"Product Code":u.product_code,Category:u.product_category||"Uncategorized","Date Received":u.rr_date,Quantity:u.received_quantity,"Cost Price":u.cost_price,Total:u.total_cost,"Payment Status":u.payment_status})),n=E.json_to_sheet(t),a=E.book_new();E.book_append_sheet(a,n,"Purchase History");const d=((h=y==null?void 0:y.supplier)==null?void 0:h.supplier_name)||"Supplier",c=new Date().toISOString().split("T")[0];_e(a,`${d}_Purchase_History_${c}.xlsx`)};if(ae)return e.jsx(K,{children:e.jsx(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"400px"},children:e.jsx(W,{})})});if(H)return e.jsxs(K,{children:[e.jsxs(s,{variant:"h5",color:"error",align:"center",children:["Error: ",H]}),e.jsx(i,{sx:{mt:2,textAlign:"center"},children:e.jsx(N,{variant:"contained",onClick:U,startIcon:e.jsx(J,{}),children:"Back to Suppliers"})})]});const{supplier:x,stats:j,items_by_po:S}=y||{},V=S?Object.keys(S).sort((t,n)=>{var c,h;const a=(c=S[t][0])==null?void 0:c.po_date,d=(h=S[n][0])==null?void 0:h.po_date;return new Date(d)-new Date(a)}):[];return e.jsxs(e.Fragment,{children:[e.jsxs(ge,{sx:{mb:2},children:[e.jsxs(D,{underline:"hover",color:"inherit",sx:{display:"flex",alignItems:"center",cursor:"pointer"},onClick:()=>g("/app/dashboard"),children:[e.jsx(ve,{style:{marginRight:8}}),"Dashboard"]}),e.jsxs(D,{underline:"hover",color:"inherit",sx:{display:"flex",alignItems:"center",cursor:"pointer"},onClick:()=>g("/app/supplier"),children:[e.jsx(Ce,{style:{marginRight:8}}),"Suppliers"]}),e.jsxs(s,{color:"text.primary",sx:{display:"flex",alignItems:"center"},children:[e.jsx(ye,{style:{marginRight:8}}),"Purchase History"]})]}),e.jsx(i,{sx:{display:"flex",justifyContent:"space-between",mb:3},children:e.jsx(N,{variant:"outlined",startIcon:e.jsx(J,{}),onClick:U,children:"Back to Suppliers"})}),e.jsxs(k,{sx:{p:3,mb:4},children:[e.jsx(s,{variant:"h5",gutterBottom:!0,children:"Supplier Details"}),e.jsxs(m,{container:!0,spacing:2,children:[e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"subtitle1",children:"Name:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.supplier_name)||"N/A"}),e.jsx(s,{variant:"subtitle1",children:"Contact Person:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.contact_person)||"N/A"})]}),e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"subtitle1",children:"Email:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.email)||"N/A"}),e.jsx(s,{variant:"subtitle1",children:"Phone:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.phone)||"N/A"}),e.jsx(s,{variant:"subtitle1",children:"Address:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.address)||"N/A"})]})]})]}),e.jsxs(k,{sx:{p:3,mb:4},children:[e.jsx(s,{variant:"h5",gutterBottom:!0,children:"Purchase Summary"}),e.jsxs(m,{container:!0,spacing:3,children:[e.jsx(m,{item:!0,xs:12,sm:3,children:e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Orders"}),e.jsx(s,{variant:"h4",sx:{my:1},children:(j==null?void 0:j.total_orders)||0})]})}),e.jsx(m,{item:!0,xs:12,sm:3,children:e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Items"}),e.jsx(s,{variant:"h4",sx:{my:1},children:(j==null?void 0:j.total_items)||0})]})}),e.jsx(m,{item:!0,xs:12,sm:3,children:e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Quantity"}),e.jsx(s,{variant:"h4",sx:{my:1},children:(j==null?void 0:j.total_quantity)||0})]})}),e.jsx(m,{item:!0,xs:12,sm:3,children:e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Value"}),e.jsx(s,{variant:"h4",sx:{my:1},children:b((j==null?void 0:j.total_value)||0)})]})})]})]}),e.jsx(i,{sx:{mb:3},children:e.jsx(Ie,{fullWidth:!0,placeholder:"Search by DR #, Product Name, Category or Total...",variant:"outlined",value:$,onChange:t=>ce(t.target.value),InputProps:{startAdornment:e.jsx(be,{position:"start",children:e.jsx(Se,{})})}})}),e.jsxs(k,{sx:{p:3},children:[e.jsx(i,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(ke,{value:_,onChange:xe,"aria-label":"purchase history tabs",children:[e.jsx(se,{label:"All Items",id:"tab-0"}),e.jsx(se,{label:"By Purchase Order",id:"tab-1"})]})}),e.jsxs(ne,{value:_,index:0,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignContent:"center",mb:1},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"All Purchased Items"}),e.jsx(N,{variant:"contained",color:"success",size:"small",startIcon:e.jsx(Pe,{}),onClick:he,disabled:!p.length,children:"Export to Excel"})]}),p.length>0?e.jsx(Z,{component:k,variant:"outlined",children:e.jsxs(ee,{size:"small",children:[e.jsx(te,{children:e.jsxs(R,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{onClick:()=>I("po_number"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(P,{title:"Sort by PO Number",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["PO Number",o.key==="po_number"&&(o.direction==="asc"?e.jsx(w,{style:{marginLeft:8}}):e.jsx(T,{style:{marginLeft:8}}))]})})}),e.jsx(r,{onClick:()=>I("batch_number"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(P,{title:"Sort by Batch #",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["Batch #",o.key==="batch_number"&&(o.direction==="asc"?e.jsx(w,{style:{marginLeft:8}}):e.jsx(T,{style:{marginLeft:8}}))]})})}),e.jsx(r,{onClick:()=>I("product_name"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(P,{title:"Sort by Product Name",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["Product",o.key==="product_name"&&(o.direction==="asc"?e.jsx(w,{style:{marginLeft:8}}):e.jsx(T,{style:{marginLeft:8}}))]})})}),e.jsx(r,{children:"Code"}),e.jsx(r,{onClick:()=>I("product_category"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(P,{title:"Sort by Category",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["Category",o.key==="product_category"&&(o.direction==="asc"?e.jsx(w,{style:{marginLeft:8}}):e.jsx(T,{style:{marginLeft:8}}))]})})}),e.jsx(r,{onClick:()=>I("rr_date"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(P,{title:"Sort by Date",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["Date",o.key==="rr_date"&&(o.direction==="asc"?e.jsx(w,{style:{marginLeft:8}}):e.jsx(T,{style:{marginLeft:8}}))]})})}),e.jsx(r,{align:"right",children:"Quantity"}),e.jsx(r,{align:"right",children:"Cost Price"}),e.jsx(r,{align:"right",children:"Item Total"}),e.jsx(r,{align:"right",children:"Grand Total"}),e.jsx(r,{children:"Status"})]})}),e.jsx(re,{children:p.map((t,n)=>{const a=n===p.length-1;return e.jsxs(R,{ref:a?ue:null,children:[e.jsx(r,{children:e.jsx(D,{href:"#",onClick:()=>g(`/app/purchase/${t.po_number}/edit`),sx:{textDecoration:"none"},children:t.po_number})}),e.jsx(r,{children:t.batch_number}),e.jsx(r,{children:t.product_name}),e.jsx(r,{children:t.product_code}),e.jsx(r,{children:t.product_category||"Uncategorized"}),e.jsx(r,{children:Y(t.rr_date)}),e.jsx(r,{align:"right",children:t.received_quantity}),e.jsx(r,{align:"right",children:b(t.cost_price)}),e.jsx(r,{align:"right",children:b(t.total_cost)}),e.jsx(r,{align:"right",children:b(t.grand_total)}),e.jsx(r,{children:e.jsx(X,{label:t.payment_status,color:t.payment_status==="Paid"?"success":"error",size:"small"})})]},t.received_item_id)})})]})}):e.jsx(i,{sx:{p:4,textAlign:"center"},children:e.jsx(s,{variant:"body1",color:"text.secondary",children:"No purchase history found for this supplier."})}),C&&e.jsx(i,{ref:de,sx:{display:"flex",justifyContent:"center",p:2},children:e.jsx(W,{size:30})})]}),e.jsxs(ne,{value:_,index:1,children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Purchases By Order"}),V.length>0?e.jsx(e.Fragment,{children:V.map(t=>{const n=S[t],a=n[0],d=n.reduce((c,h)=>c+h.total_cost,0);return e.jsxs(i,{sx:{mb:4},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(i,{children:[e.jsx(s,{variant:"h6",sx:{color:"primary.main"},children:e.jsxs(D,{href:"#",onClick:()=>g(`/app/purchase/${t}/edit`),sx:{textDecoration:"none"},children:["PO #: ",t]})}),e.jsxs(s,{variant:"body2",children:["Date: ",Y(a.po_date)," | Batch #: ",a.batch_number," | Invoice: ",a.invoice!=="N/A"?a.invoice:"Not Available"]})]}),e.jsx(i,{children:e.jsx(X,{label:a.payment_status,color:a.payment_status==="Paid"?"success":"error",size:"small"})})]}),e.jsx(Z,{component:k,variant:"outlined",children:e.jsxs(ee,{size:"small",children:[e.jsx(te,{children:e.jsxs(R,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{children:"Product"}),e.jsx(r,{children:"Code"}),e.jsx(r,{children:"Category"}),e.jsx(r,{align:"right",children:"Quantity"}),e.jsx(r,{align:"right",children:"Cost Price"}),e.jsx(r,{align:"right",children:"Total"})]})}),e.jsxs(re,{children:[n.map((c,h)=>e.jsxs(R,{children:[e.jsx(r,{children:c.product_name}),e.jsx(r,{children:c.product_code}),e.jsx(r,{children:c.product_category||"Uncategorized"}),e.jsx(r,{align:"right",children:c.received_quantity}),e.jsx(r,{align:"right",children:b(c.cost_price)}),e.jsx(r,{align:"right",children:b(c.total_cost)})]},h)),e.jsxs(R,{children:[e.jsx(r,{colSpan:4}),e.jsx(r,{align:"right",children:e.jsx(s,{variant:"subtitle2",children:"Order Total:"})}),e.jsx(r,{align:"right",children:e.jsx(s,{variant:"subtitle2",children:b(d)})})]})]})]})}),e.jsx(fe,{sx:{my:4}})]},t)})}):e.jsx(i,{sx:{p:4,textAlign:"center"},children:e.jsx(s,{variant:"body1",color:"text.secondary",children:"No purchase orders found for this supplier."})})]})]})]})};export{Me as default};
