import{V as pe,K as je,r as l,W as me,j as e,M as N,v as i,X as J,T as s,l as O,Y as ge,U as ye,P as S,G as m,F as fe,J as A,z as K,D as be}from"./index-DeRU5HNF.js";import{f as v,a as X}from"./currencyFormat-BsuV9MhS.js";import{u as E,w as _e}from"./xlsx-DjuO7_Ju.js";import{R as Y,a as ve,b as B}from"./LeftOutlined-CcelUQ2f.js";import{L}from"./Link-Czyf3azh.js";import{R as Ce}from"./HomeOutlined-CO4yDJya.js";import{R as Ie,a as D}from"./TeamOutlined-C9KvFSvs.js";import{T as Se,c as Z,d as ee,e as te,a as k,b as r,f as re}from"./TextField-BYf4anuv.js";import{R as ke}from"./SearchOutlined-BPbN8RAA.js";import{T as Pe,a as se}from"./Tabs-CROoasCq.js";import"./InputLabel-p4Y1ucBq.js";import"./KeyboardArrowRight-DrhUjlpq.js";function ne(f){const{children:g,value:b,index:_,...C}=f;return e.jsx("div",{role:"tabpanel",hidden:b!==_,id:`simple-tabpanel-${_}`,"aria-labelledby":`simple-tab-${_}`,...C,children:b===_&&e.jsx(i,{sx:{pt:2},children:g})})}const He=()=>{const{supplierId:f}=pe(),g=je(),[b,_]=l.useState(0),[C,z]=l.useState(!0),[ae,H]=l.useState(!0),[M,ie]=l.useState(null),[y,q]=l.useState(null),[j,P]=l.useState([]),[F,V]=l.useState(1),[Q,oe]=l.useState(!0),[$,ce]=l.useState(""),[o,le]=l.useState({key:null,direction:"asc"}),T=l.useRef(),de=l.useRef(),xe=(t,n)=>{_(n)},U=()=>{g("/app/supplier")},w=l.useCallback(async(t=1,n=!1)=>{var a;if(f)try{z(!0);const d=await me.get(`/suppliers/${f}/purchase-history?page=${t}&per_page=50`);n?(q(d.data.data),P(d.data.data.items||[])):(q(c=>{if(!c)return d.data.data;const h=[...c.items,...d.data.data.items||[]],u=Array.from(new Map(h.map(W=>[W.received_item_id,W])).values());return{...d.data.data,items:u,items_by_po:d.data.data.items_by_po}}),P(c=>{const h=[...c,...d.data.data.items||[]];return Array.from(new Map(h.map(u=>[u.received_item_id,u])).values())})),oe(((a=d.data.data.pagination)==null?void 0:a.has_more)||!1),H(!1)}catch(d){ie(d.message||"Failed to load data"),H(!1)}finally{z(!1)}},[f]),ue=l.useCallback(t=>{C||(T.current&&T.current.disconnect(),T.current=new IntersectionObserver(n=>{if(n[0].isIntersecting&&Q){const a=F+1;V(a),w(a)}}),t&&T.current.observe(t))},[C,Q,F,w]);l.useEffect(()=>{V(1),w(1,!0)},[f,w]),l.useEffect(()=>{if(!y)return;const t=y.items.filter(n=>{const a=$.toLowerCase();return n.po_number.toLowerCase().includes(a)||n.product_name.toLowerCase().includes(a)||n.total_cost.toString().includes(a)||n.batch_number.toLowerCase().includes(a)||n.product_category&&n.product_category.toLowerCase().includes(a)});P(t)},[$,y]);const R=t=>{let n="asc";o.key===t&&o.direction==="asc"&&(n="desc"),le({key:t,direction:n})};l.useEffect(()=>{if(!o.key||!j.length)return;const t=[...j].sort((n,a)=>n[o.key]<a[o.key]?o.direction==="asc"?-1:1:n[o.key]>a[o.key]?o.direction==="asc"?1:-1:0);P(t)},[o]);const he=()=>{var h;if(!j.length)return;const t=j.map(u=>({"PO Number":u.po_number,Product:u.product_name,"Product Code":u.product_code,Category:u.product_category||"Uncategorized","Date Received":u.rr_date,Quantity:u.received_quantity,"Cost Price":u.cost_price,Total:u.total_cost,"Payment Status":u.payment_status})),n=E.json_to_sheet(t),a=E.book_new();E.book_append_sheet(a,n,"Purchase History");const d=((h=y==null?void 0:y.supplier)==null?void 0:h.supplier_name)||"Supplier",c=new Date().toISOString().split("T")[0];_e(a,`${d}_Purchase_History_${c}.xlsx`)};if(ae)return e.jsx(N,{children:e.jsx(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"400px"},children:e.jsx(J,{})})});if(M)return e.jsxs(N,{children:[e.jsxs(s,{variant:"h5",color:"error",align:"center",children:["Error: ",M]}),e.jsx(i,{sx:{mt:2,textAlign:"center"},children:e.jsx(O,{variant:"contained",onClick:U,startIcon:e.jsx(Y,{}),children:"Back to Suppliers"})})]});const{supplier:x,stats:p,items_by_po:I}=y||{},G=I?Object.keys(I).sort((t,n)=>{var c,h;const a=(c=I[t][0])==null?void 0:c.po_date,d=(h=I[n][0])==null?void 0:h.po_date;return new Date(d)-new Date(a)}):[];return e.jsxs(N,{children:[e.jsxs(ge,{sx:{mb:2},children:[e.jsxs(L,{underline:"hover",color:"inherit",sx:{display:"flex",alignItems:"center",cursor:"pointer"},onClick:()=>g("/app/dashboard"),children:[e.jsx(Ce,{style:{marginRight:8}}),"Dashboard"]}),e.jsxs(L,{underline:"hover",color:"inherit",sx:{display:"flex",alignItems:"center",cursor:"pointer"},onClick:()=>g("/app/supplier"),children:[e.jsx(Ie,{style:{marginRight:8}}),"Suppliers"]}),e.jsxs(s,{color:"text.primary",sx:{display:"flex",alignItems:"center"},children:[e.jsx(ye,{style:{marginRight:8}}),"Purchase History"]})]}),e.jsx(i,{sx:{display:"flex",justifyContent:"space-between",mb:3},children:e.jsx(O,{variant:"outlined",startIcon:e.jsx(Y,{}),onClick:U,children:"Back to Suppliers"})}),e.jsxs(S,{sx:{p:3,mb:4},children:[e.jsx(s,{variant:"h5",gutterBottom:!0,children:"Supplier Details"}),e.jsxs(m,{container:!0,spacing:2,children:[e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"subtitle1",children:"Name:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.supplier_name)||"N/A"}),e.jsx(s,{variant:"subtitle1",children:"Contact Person:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.contact_person)||"N/A"})]}),e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"subtitle1",children:"Email:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.email)||"N/A"}),e.jsx(s,{variant:"subtitle1",children:"Phone:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.phone)||"N/A"}),e.jsx(s,{variant:"subtitle1",children:"Address:"}),e.jsx(s,{variant:"body1",gutterBottom:!0,children:(x==null?void 0:x.address)||"N/A"})]})]})]}),e.jsxs(S,{sx:{p:3,mb:4},children:[e.jsx(s,{variant:"h5",gutterBottom:!0,children:"Purchase Summary"}),e.jsxs(m,{container:!0,spacing:3,children:[e.jsx(m,{item:!0,xs:12,sm:3,children:e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Orders"}),e.jsx(s,{variant:"h4",sx:{my:1},children:(p==null?void 0:p.total_orders)||0})]})}),e.jsx(m,{item:!0,xs:12,sm:3,children:e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Items"}),e.jsx(s,{variant:"h4",sx:{my:1},children:(p==null?void 0:p.total_items)||0})]})}),e.jsx(m,{item:!0,xs:12,sm:3,children:e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Quantity"}),e.jsx(s,{variant:"h4",sx:{my:1},children:(p==null?void 0:p.total_quantity)||0})]})}),e.jsx(m,{item:!0,xs:12,sm:3,children:e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Total Value"}),e.jsx(s,{variant:"h4",sx:{my:1},children:v((p==null?void 0:p.total_value)||0)})]})})]})]}),e.jsx(i,{sx:{mb:3},children:e.jsx(Se,{fullWidth:!0,placeholder:"Search by DR #, Product Name, Category or Total...",variant:"outlined",value:$,onChange:t=>ce(t.target.value),InputProps:{startAdornment:e.jsx(fe,{position:"start",children:e.jsx(ke,{})})}})}),e.jsxs(S,{sx:{p:3},children:[e.jsx(i,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Pe,{value:b,onChange:xe,"aria-label":"purchase history tabs",children:[e.jsx(se,{label:"All Items",id:"tab-0"}),e.jsx(se,{label:"By Purchase Order",id:"tab-1"})]})}),e.jsxs(ne,{value:b,index:0,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignContent:"center",mb:1},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"All Purchased Items"}),e.jsx(O,{variant:"contained",color:"success",size:"small",startIcon:e.jsx(ve,{}),onClick:he,disabled:!j.length,children:"Export to Excel"})]}),j.length>0?e.jsx(Z,{component:S,variant:"outlined",children:e.jsxs(ee,{size:"small",children:[e.jsx(te,{children:e.jsxs(k,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{onClick:()=>R("po_number"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(A,{title:"Sort by PO Number",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["PO Number",o.key==="po_number"&&(o.direction==="asc"?e.jsx(D,{style:{marginLeft:8}}):e.jsx(B,{style:{marginLeft:8}}))]})})}),e.jsx(r,{onClick:()=>R("product_name"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(A,{title:"Sort by Product Name",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["Product",o.key==="product_name"&&(o.direction==="asc"?e.jsx(D,{style:{marginLeft:8}}):e.jsx(B,{style:{marginLeft:8}}))]})})}),e.jsx(r,{children:"Code"}),e.jsx(r,{onClick:()=>R("product_category"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(A,{title:"Sort by Category",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["Category",o.key==="product_category"&&(o.direction==="asc"?e.jsx(D,{style:{marginLeft:8}}):e.jsx(B,{style:{marginLeft:8}}))]})})}),e.jsx(r,{onClick:()=>R("rr_date"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(A,{title:"Sort by Date",arrow:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:["Date",o.key==="rr_date"&&(o.direction==="asc"?e.jsx(D,{style:{marginLeft:8}}):e.jsx(B,{style:{marginLeft:8}}))]})})}),e.jsx(r,{align:"right",children:"Quantity"}),e.jsx(r,{align:"right",children:"Cost Price"}),e.jsx(r,{align:"right",children:"Total"}),e.jsx(r,{children:"Status"})]})}),e.jsx(re,{children:j.map((t,n)=>{const a=n===j.length-1;return e.jsxs(k,{ref:a?ue:null,children:[e.jsx(r,{children:e.jsx(L,{href:"#",onClick:()=>g(`/app/purchase/${t.po_number}/edit`),sx:{textDecoration:"none"},children:t.po_number})}),e.jsx(r,{children:t.product_name}),e.jsx(r,{children:t.product_code}),e.jsx(r,{children:t.product_category||"Uncategorized"}),e.jsx(r,{children:X(t.rr_date)}),e.jsx(r,{align:"right",children:t.received_quantity}),e.jsx(r,{align:"right",children:v(t.cost_price)}),e.jsx(r,{align:"right",children:v(t.total_cost)}),e.jsx(r,{children:e.jsx(K,{label:t.payment_status,color:t.payment_status==="Paid"?"success":"error",size:"small"})})]},t.received_item_id)})})]})}):e.jsx(i,{sx:{p:4,textAlign:"center"},children:e.jsx(s,{variant:"body1",color:"text.secondary",children:"No purchase history found for this supplier."})}),C&&e.jsx(i,{ref:de,sx:{display:"flex",justifyContent:"center",p:2},children:e.jsx(J,{size:30})})]}),e.jsxs(ne,{value:b,index:1,children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Purchases By Order"}),G.length>0?e.jsx(e.Fragment,{children:G.map(t=>{const n=I[t],a=n[0],d=n.reduce((c,h)=>c+h.total_cost,0);return e.jsxs(i,{sx:{mb:4},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(i,{children:[e.jsx(s,{variant:"h6",sx:{color:"primary.main"},children:e.jsxs(L,{href:"#",onClick:()=>g(`/app/purchase/${t}/edit`),sx:{textDecoration:"none"},children:["PO #: ",t]})}),e.jsxs(s,{variant:"body2",children:["Date: ",X(a.po_date)," | Batch #: ",a.batch_number," | Invoice: ",a.invoice!=="N/A"?a.invoice:"Not Available"]})]}),e.jsx(i,{children:e.jsx(K,{label:a.payment_status,color:a.payment_status==="Paid"?"success":"error",size:"small"})})]}),e.jsx(Z,{component:S,variant:"outlined",children:e.jsxs(ee,{size:"small",children:[e.jsx(te,{children:e.jsxs(k,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{children:"Product"}),e.jsx(r,{children:"Code"}),e.jsx(r,{children:"Category"}),e.jsx(r,{align:"right",children:"Quantity"}),e.jsx(r,{align:"right",children:"Cost Price"}),e.jsx(r,{align:"right",children:"Total"})]})}),e.jsxs(re,{children:[n.map((c,h)=>e.jsxs(k,{children:[e.jsx(r,{children:c.product_name}),e.jsx(r,{children:c.product_code}),e.jsx(r,{children:c.product_category||"Uncategorized"}),e.jsx(r,{align:"right",children:c.received_quantity}),e.jsx(r,{align:"right",children:v(c.cost_price)}),e.jsx(r,{align:"right",children:v(c.total_cost)})]},h)),e.jsxs(k,{children:[e.jsx(r,{colSpan:4}),e.jsx(r,{align:"right",children:e.jsx(s,{variant:"subtitle2",children:"Order Total:"})}),e.jsx(r,{align:"right",children:e.jsx(s,{variant:"subtitle2",children:v(d)})})]})]})]})}),e.jsx(be,{sx:{my:4}})]},t)})}):e.jsx(i,{sx:{p:4,textAlign:"center"},children:e.jsx(s,{variant:"body1",color:"text.secondary",children:"No purchase orders found for this supplier."})})]})]})]})};export{He as default};
