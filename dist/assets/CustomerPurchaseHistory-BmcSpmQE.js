import{ab as fe,a5 as be,r as l,Y as ye,j as e,M as W,K as o,_ as X,T as n,E as L,ac as ve,at as _e,P as I,U as g,a4 as Ce,$ as N,X as Y,L as Ie}from"./index-P7JVNn7a.js";import{f as $}from"./dateUtils-Dj0n6tHU.js";import{f}from"./currencyFormat-th2sljt-.js";import{u as E,w as ke}from"./xlsx-DjuO7_Ju.js";import{R as J,a as F}from"./LeftOutlined-Acat_fH2.js";import{L as P}from"./Link-BQi1lbOd.js";import{R as Se}from"./HomeOutlined-D4DgG3YH.js";import{R as Te,a as O}from"./TeamOutlined-ShSoFfVS.js";import{T as Re,c as Z,d as ee,e as te,a as k,b as r,f as re}from"./TextField-CQUS4omo.js";import{R as we}from"./SearchOutlined-DaSXuFk-.js";import{T as Pe,a as se}from"./Tabs-DjAOieGp.js";import{R as De}from"./FileExcelOutlined-DmBZH1un.js";import"./InputLabel-DlxItPrF.js";import"./KeyboardArrowRight-DWAtJwBs.js";function ne(x){const{children:j,value:b,index:y,...C}=x;return e.jsx("div",{role:"tabpanel",hidden:b!==y,id:`simple-tabpanel-${y}`,"aria-labelledby":`simple-tab-${y}`,...C,children:b===y&&e.jsx(o,{sx:{pt:2},children:j})})}const Ve=()=>{const{customerId:x}=fe(),j=be(),[b,y]=l.useState(0),[C,z]=l.useState(!0),[ie,H]=l.useState(!0),[M,oe]=l.useState(null),[m,q]=l.useState(null),[h,S]=l.useState([]),[Q,U]=l.useState(1),[V,le]=l.useState(!0),[D,ce]=l.useState(""),[c,de]=l.useState({key:null,direction:"asc"}),T=l.useRef(),ue=l.useRef(),xe=(t,s)=>{y(s)},G=()=>{j("/app/customer")},R=l.useCallback(async(t=1,s=!1)=>{var a;if(x)try{z(!0);const d=await ye.get(`/sales/customers/${x}/purchase-history?page=${t}&per_page=50`);s?(q(d.data.data),S(d.data.data.items||[])):(q(v=>{if(!v)return d.data.data;const _=[...v.items,...d.data.data.items||[]],u=Array.from(new Map(_.map(K=>[K.item_id,K])).values());return{...d.data.data,items:u}}),S(v=>{const _=[...v,...d.data.data.items||[]];return Array.from(new Map(_.map(u=>[u.item_id,u])).values())})),le(((a=d.data.data.pagination)==null?void 0:a.has_more)||!1),H(!1)}catch(d){oe(d.message||"Failed to load data"),H(!1)}finally{z(!1)}},[x]),he=l.useCallback(t=>{C||(T.current&&T.current.disconnect(),T.current=new IntersectionObserver(s=>{if(s[0].isIntersecting&&V){const a=Q+1;U(a),R(a)}}),t&&T.current.observe(t))},[C,V,Q,R]);l.useEffect(()=>{U(1),R(1,!0)},[x,R]),l.useEffect(()=>{if(!m)return;const t=m.items.filter(s=>{const a=D.toLowerCase();return s.invoice_number.toLowerCase().includes(a)||s.product_name.toLowerCase().includes(a)||s.total.toString().includes(a)||s.total_sale_amount.toString().includes(a)||s.product_code&&s.product_code.toLowerCase().includes(a)});S(t)},[D,m]);const A=t=>{let s="asc";c.key===t&&c.direction==="asc"&&(s="desc"),de({key:t,direction:s})};l.useEffect(()=>{if(!c.key||!h.length)return;const t=[...h].sort((s,a)=>s[c.key]<a[c.key]?c.direction==="asc"?-1:1:s[c.key]>a[c.key]?c.direction==="asc"?1:-1:0);S(t)},[c]);const je=()=>{var _;if(!h.length)return;const t=h.map(u=>({"DR Number":u.invoice_number,Product:u.product_name,"Product Code":u.product_code||"N/A",Quantity:u.quantity,Price:u.price,Discount:u.discount+"%",Total:u.total,Date:u.order_date,Status:u.status})),s=E.json_to_sheet(t),a=E.book_new();E.book_append_sheet(a,s,"Purchase History");const d=((_=m==null?void 0:m.customer)==null?void 0:_.customer_name)||"Customer",v=new Date().toISOString().split("T")[0];ke(a,`${d}_Purchase_History_${v}.xlsx`)};if(ie)return e.jsx(W,{children:e.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"400px"},children:e.jsx(X,{})})});if(M)return e.jsxs(W,{children:[e.jsxs(n,{variant:"h5",color:"error",align:"center",children:["Error: ",M]}),e.jsx(o,{sx:{mt:2,textAlign:"center"},children:e.jsx(L,{variant:"contained",onClick:G,startIcon:e.jsx(J,{}),children:"Back to Customers"})})]});const{customer:i,items:p}=m||{},w={};p&&p.length>0&&p.forEach(t=>{w[t.invoice_number]||(w[t.invoice_number]={invoice_number:t.invoice_number,order_date:t.order_date,delivery_date:t.delivery_date,status:t.status,items:[]}),w[t.invoice_number].items.push(t)});const B=Object.values(w).sort((t,s)=>new Date(s.order_date)-new Date(t.order_date)),me=p?p.reduce((t,s)=>t+parseFloat(s.total),0):0,pe=p?p.reduce((t,s)=>t+parseInt(s.quantity),0):0,ge=B.length;return e.jsxs(e.Fragment,{children:[e.jsxs(ve,{sx:{mb:2},children:[e.jsxs(P,{underline:"hover",color:"inherit",sx:{display:"flex",alignItems:"center",cursor:"pointer"},onClick:()=>j("/app/dashboard"),children:[e.jsx(Se,{style:{marginRight:8}}),"Dashboard"]}),e.jsxs(P,{underline:"hover",color:"inherit",sx:{display:"flex",alignItems:"center",cursor:"pointer"},onClick:()=>j("/app/customer"),children:[e.jsx(Te,{style:{marginRight:8}}),"Customers"]}),e.jsxs(n,{color:"text.primary",sx:{display:"flex",alignItems:"center"},children:[e.jsx(_e,{style:{marginRight:8}}),"Purchase History"]})]}),e.jsx(L,{variant:"outlined",startIcon:e.jsx(J,{}),onClick:G,sx:{mb:3},children:"Back to Customers"}),e.jsxs(I,{sx:{p:3,mb:4},children:[e.jsx(n,{variant:"h5",gutterBottom:!0,children:"Customer Details"}),e.jsxs(g,{container:!0,spacing:2,children:[e.jsxs(g,{item:!0,xs:12,md:6,children:[e.jsx(n,{variant:"subtitle1",children:"Name:"}),e.jsx(n,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.customer_name)||"N/A"}),(i==null?void 0:i.business_name)&&e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"subtitle1",children:"Business:"}),e.jsx(n,{variant:"body1",gutterBottom:!0,children:i.business_name})]}),e.jsx(n,{variant:"subtitle1",children:"Contact Number:"}),e.jsx(n,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.contact_number)||"N/A"})]}),e.jsxs(g,{item:!0,xs:12,md:6,children:[e.jsx(n,{variant:"subtitle1",children:"Email:"}),e.jsx(n,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.email)||"N/A"}),e.jsx(n,{variant:"subtitle1",children:"Address:"}),e.jsx(n,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.address)||"N/A"}),e.jsx(n,{variant:"subtitle1",children:"City:"}),e.jsx(n,{variant:"body1",gutterBottom:!0,children:(i==null?void 0:i.city)||"N/A"})]})]})]}),e.jsxs(I,{sx:{p:3,mb:4},children:[e.jsx(n,{variant:"h5",gutterBottom:!0,children:"Purchase Summary"}),e.jsxs(g,{container:!0,spacing:3,children:[e.jsx(g,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",children:"Total Orders"}),e.jsx(n,{variant:"h4",sx:{my:1},children:ge})]})}),e.jsx(g,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",children:"Total Items Purchased"}),e.jsx(n,{variant:"h4",sx:{my:1},children:pe})]})}),e.jsx(g,{item:!0,xs:12,sm:4,children:e.jsxs(o,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1,textAlign:"center"},children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",children:"Total Purchase Amount"}),e.jsx(n,{variant:"h4",sx:{my:1},children:f(me)})]})})]})]}),e.jsx(o,{sx:{mb:3},children:e.jsx(Re,{fullWidth:!0,placeholder:"Search by DR #, Product Name or Total...",variant:"outlined",value:D,onChange:t=>ce(t.target.value),InputProps:{startAdornment:e.jsx(Ce,{position:"start",children:e.jsx(we,{})})}})}),e.jsxs(I,{sx:{p:3},children:[e.jsx(o,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Pe,{value:b,onChange:xe,"aria-label":"purchase history tabs",children:[e.jsx(se,{label:"All Items",id:"tab-0"}),e.jsx(se,{label:"By Orders",id:"tab-1"})]})}),e.jsxs(ne,{value:b,index:0,children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignContent:"center",mb:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,children:"All Purchased Items"}),e.jsx(L,{variant:"contained",color:"success",size:"small",startIcon:e.jsx(De,{}),onClick:je,disabled:!h.length,children:"Export to Excel"})]}),h.length>0?e.jsx(Z,{component:I,variant:"outlined",children:e.jsxs(ee,{size:"small",children:[e.jsx(te,{children:e.jsxs(k,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{onClick:()=>A("invoice_number"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(N,{title:"Sort by DR Number",arrow:!0,children:e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:["DR Number",c.key==="invoice_number"&&(c.direction==="asc"?e.jsx(O,{style:{marginLeft:8}}):e.jsx(F,{style:{marginLeft:8}}))]})})}),e.jsx(r,{onClick:()=>A("product_name"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(N,{title:"Sort by Product Name",arrow:!0,children:e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:["Product",c.key==="product_name"&&(c.direction==="asc"?e.jsx(O,{style:{marginLeft:8}}):e.jsx(F,{style:{marginLeft:8}}))]})})}),e.jsx(r,{children:"Code"}),e.jsx(r,{onClick:()=>A("order_date"),sx:{cursor:"pointer",userSelect:"none"},children:e.jsx(N,{title:"Sort by Date",arrow:!0,children:e.jsxs(o,{sx:{display:"flex",alignItems:"center"},children:["Date",c.key==="order_date"&&(c.direction==="asc"?e.jsx(O,{style:{marginLeft:8}}):e.jsx(F,{style:{marginLeft:8}}))]})})}),e.jsx(r,{align:"right",children:"Unit Price"}),e.jsx(r,{align:"center",children:"Quantity"}),e.jsx(r,{align:"right",children:"Discount"}),e.jsx(r,{align:"right",children:"Item Total"}),e.jsx(r,{align:"right",children:"Total Sale"}),e.jsx(r,{children:"Status"})]})}),e.jsx(re,{children:h.map((t,s)=>{const a=s===h.length-1;return e.jsxs(k,{ref:a?he:null,children:[e.jsx(r,{children:e.jsx(P,{href:"#",onClick:()=>j(`/app/delivery-report/${t.sale_id}`),sx:{textDecoration:"none"},children:t.invoice_number})}),e.jsx(r,{children:t.product_name}),e.jsx(r,{children:t.product_code||"N/A"}),e.jsx(r,{children:$(t.order_date)}),e.jsx(r,{align:"right",children:f(t.price)}),e.jsx(r,{align:"center",children:t.quantity}),e.jsxs(r,{align:"right",children:[parseFloat(t.discount).toFixed(2),"%"]}),e.jsx(r,{align:"right",children:f(t.total)}),e.jsx(r,{align:"right",children:f(t.total_sale_amount)}),e.jsx(r,{children:e.jsx(Y,{label:t.status,color:ae(t.status),size:"small"})})]},t.item_id)})})]})}):e.jsx(o,{sx:{p:4,textAlign:"center"},children:e.jsx(n,{variant:"body1",color:"text.secondary",children:"No purchase history found for this customer."})}),C&&e.jsx(o,{ref:ue,sx:{display:"flex",justifyContent:"center",p:2},children:e.jsx(X,{size:30})})]}),e.jsxs(ne,{value:b,index:1,children:[e.jsx(n,{variant:"h6",gutterBottom:!0,children:"Purchases By Order"}),B.length>0?e.jsx(e.Fragment,{children:B.map(t=>{const s=t.items.reduce((a,d)=>a+parseFloat(d.total),0);return e.jsxs(o,{sx:{mb:4},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(o,{children:[e.jsx(n,{variant:"h6",sx:{color:"primary.main"},children:e.jsxs(P,{href:"#",onClick:()=>j(`/app/sales/${t.items[0].sale_id}`),sx:{textDecoration:"none"},children:["DR #: ",t.invoice_number]})}),e.jsxs(n,{variant:"body2",children:["Order Date: ",$(t.order_date)," | Delivery Date: ",$(t.delivery_date)]})]}),e.jsx(o,{children:e.jsx(Y,{label:t.status,color:ae(t.status),size:"small"})})]}),e.jsx(Z,{component:I,variant:"outlined",children:e.jsxs(ee,{size:"small",children:[e.jsx(te,{children:e.jsxs(k,{sx:{backgroundColor:"#f5f5f5"},children:[e.jsx(r,{children:"Product"}),e.jsx(r,{children:"Code"}),e.jsx(r,{align:"right",children:"Unit Price"}),e.jsx(r,{align:"center",children:"Quantity"}),e.jsx(r,{align:"right",children:"Discount"}),e.jsx(r,{align:"right",children:"Total"})]})}),e.jsxs(re,{children:[t.items.map((a,d)=>e.jsxs(k,{children:[e.jsx(r,{children:a.product_name}),e.jsx(r,{children:a.product_code||"N/A"}),e.jsx(r,{align:"right",children:f(a.price)}),e.jsx(r,{align:"center",children:a.quantity}),e.jsxs(r,{align:"right",children:[parseFloat(a.discount).toFixed(2),"%"]}),e.jsx(r,{align:"right",children:f(a.total)})]},d)),e.jsxs(k,{children:[e.jsx(r,{colSpan:4}),e.jsx(r,{align:"right",children:e.jsx(n,{variant:"subtitle2",children:"Order Total:"})}),e.jsx(r,{align:"right",children:e.jsx(n,{variant:"subtitle2",children:f(s)})})]})]})]})}),e.jsx(Ie,{sx:{my:4}})]},t.invoice_number)})}):e.jsx(o,{sx:{p:4,textAlign:"center"},children:e.jsx(n,{variant:"body1",color:"text.secondary",children:"No purchase orders found for this customer."})})]})]})]})},ae=x=>{switch(x.toLowerCase()){case"completed":return"success";case"pending":return"warning";case"cancelled":return"error";case"partially_paid":case"partially_returned":return"info";case"unpaid":return"default";default:return"default"}};export{Ve as default};
